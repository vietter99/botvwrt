#!/bin/sh /etc/rc.common

START=99
STOP=10
USE_PROCD=1

SCRIPT="/root/bot_openwrt.py"
PYTHON_BIN="/usr/bin/python3"

. /lib/functions.sh

load_bot_config() {
    config_load telegram_bot
    config_get TELEGRAM_TOKEN main telegram_token
    config_get OPENAI_API_KEY main openai_key
    config_get GEMINI_API_KEY main gemini_key
    config_get ADMIN_ID       main admin_id
}

start_service() {
    load_bot_config

    if [ -z "$TELEGRAM_TOKEN" ]; then
        logger -t telegram_bot "TELEGRAM_TOKEN chưa cấu hình, không start bot"
        return 1
    fi

    procd_open_instance

    procd_set_param env \
        TELEGRAM_TOKEN="$TELEGRAM_TOKEN" \
        OPENAI_API_KEY="$OPENAI_API_KEY" \
        GEMINI_API_KEY="$GEMINI_API_KEY" \
        ADMIN_ID="$ADMIN_ID"

    procd_set_param command "$PYTHON_BIN" -u "$SCRIPT"
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
}

stop_service() {
    :
}
